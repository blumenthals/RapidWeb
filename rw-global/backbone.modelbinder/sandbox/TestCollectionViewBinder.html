<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta content="text/html;charset=UTF-8" http-equiv="Content-Type"/>
    <title>Test the CollectionViewBinder</title>

    <!-- include source files here... -->
    <script type="text/javascript" src="../public/javascripts/underscore.js"></script>
    <script type="text/javascript" src="../public/javascripts/jquery.js"></script>
    <script type="text/javascript" src="../public/javascripts/backbone.js"></script>
    <script type="text/javascript" src="../Backbone.ModelBinder.js"></script>
    <script type="text/javascript" src="../Backbone.CollectionViewBinder.js"></script>

    <script>
        $().ready(function () {

            collection = new Backbone.Collection([
                {id: 0, firstName: 'Adam', lastName: 'Zebra'},
                {id: 1, firstName: 'Bob', phone: '1234567'}
            ]);

            view = new Backbone.View();
            view.setElement($('#viewContent'));

            // Normally this will be in a separate html template file
            var rowHtml = '<tr><td data-name="firstName"></td><td data-name="lastName"></td><td data-name="phone"></td></tr>';

            // The managerFactory helps to generate element managers - an el manager creates/removes elements when models are added to a collection
            // The first arg is the parent element that will contain all of the created elements generated by the element managers
            // The 3rd arg is the bindings attribute name we are binding the nested view elements on
            var elManagerFactory = new Backbone.CollectionViewBinder.ElManagerFactory(rowHtml, "data-name");

            // This is how you bind a collection to a view
            collectionViewBinder = new Backbone.CollectionViewBinder(elManagerFactory);


            // This is very similar to the ModelBinder.bind() function but the CollectionViewBinder will also create nested element views
            collectionViewBinder.createBoundEls(collection, view.$('tbody'));



            // Demonstrating that the elManagerFactory has create/remove events you can listen to
            collectionViewBinder.on('elCreated', function(model, el){
                console.log('The first el manager factory created an element ', model, el);
            });

            collectionViewBinder.on('elRemoved', function(model, el){
                console.log('The first el manager factory removed an element ', model, el);
            });

            //////////////////////////////////////////////////////////////////////////////////////////////////
            // The handlers below just help demonstrate that the rows in the table are bound to the collection
            modelCreateCount = 2;
            $('#createModel').on('click', function(){
                collection.add({id: modelCreateCount, firstName: 'Jon ' + modelCreateCount, lastName: 'Doe ' + modelCreateCount, phone: 'xxx '});
                modelCreateCount++;
            });

            $('#removeModel').on('click', function(){
                if(collection.length > 0){
                    collection.remove(collection.at(collection.length - 1));
                }
            });

            modelUpdateCount = 0;
            $('#updateModel').on('click', function(){
                if(collection.length > 0){
                    collection.at(collection.length - 1).set({phone: 'xxx ' + modelUpdateCount});
                    modelUpdateCount++;
                }
            });

            $('#resetCollection').on('click', function(){
                collection.reset();
            });

        });

    </script>

</head>
<body>
<br>
<input type="button" id="createModel" value="Create Model"/>
<input type="button" id="removeModel" value="Remove Last Model"/>
<input type="button" id="updateModel" value="Update Last Model's Phone"/>
&nbsp;&nbsp;&nbsp;
<input type="button" id="resetCollection" value="Reset Collection"/>
<br>
<br>

View content:<hr>
<div id="viewContent">

    <table>
        <thead>
            <tr>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Phone</th>
            </tr>
        </thead>

        <tbody>

        </tbody>
    </table>
</div>


</body>
</html>
